---
---
---

# OHDSI Hades R Packages Dependencies

2022-07-31

Martijin Schuemie, Adam Black, Raj Manickam

Goal

1.  Increase stability of HADES by only depending on reliable third-party packages.
2.  Reduce the HADES install footprint by removing dependencies that can be easily replaced.

Scope

R language dependencies only. Other languages (including Java dependencies) are not in scope for this effort.

Approach

1.  Start with base version of R
2.  Install OHDSI/Hades
3.  Install minimal packages to extract dependencies and create reports

```{r}
sessionInfo()
searchpaths()
```

Need to install `drat` package to capture dependencies of non-CRAN packages

```{r}
install.packages('drat', repos="https://cloud.r-project.org")
drat::addRepo("OHDSI") # so that available.packages includes Hades packages not on CRAN
```

```{r}
hadesPackages <- Hades::listHadesPackages()[,"name"]
hadesPackages
```

```{r}
library(tidyverse)
df <- available.packages(repos="https://cloud.r-project.org") %>%
  as_tibble() %>%
  filter(Package %in% hadesPackages) %>%
  select(Package, Depends, Imports, Suggests, Version, LinkingTo, MD5sum) %>%
  tidyr::pivot_longer(cols = c(-Package), names_to = "type", values_to = "dependency") %>%
  mutate(dependency = stringr::str_split(dependency, ",")) %>%
  tidyr::unnest(c(dependency)) %>%
  mutate(dependency = stringr::str_trim(dependency))

readr::write_csv(df, "hadesDependencies.csv")
# View(df)
```

```{r}
setdiff(hadesPackages, df$Package)
```

df has only 23 entries. Missing `OHDSI/EnsemblePatientLevelPrediction`. Ignore and move on for now.

Start with understanding role of `DESCRIPTION` and `NAMESPACE`

`NAMESPACE` has two roles:

1.  Identify functions from other packages that are used in our package
2.  Identify functions in our package that are exported (exposed) from use in other packages or R code

We are interested only in #1

`NAMESPACE` is auto-generated by documentation packages like `roxygen2`. As long as developers are inserting documentation tags appropriately, NAMESPACE **will** contain correct entries.

Examining `NAMESPACE` of `CohortMethod`:

Has entries for `S3method, export, import, importFrom, useDynlib.` Will focus on `import, importFrom` .

Not sure what difference is; but looking at corresponding entries in `DESCRIPTION`, `import` seems to correspond to `Depends` and `importFrom` points to entries in `Imports` .

This seems to imply there is overlap / dependencies between `DESCRIPTION` and `NAMESPACE`. Wonder if `DESCRIPTION` alone is good enough for our needs (as it has the sections `Depends, Imports, Suggests` . Interesting, there is an additional section in `DESCRIPTION` that seems to be relevant for us.

`Depends, Imports, Suggests`. Optionally, `Title, Version, Date, URL, LinkingTo, MD5sum, RoxygenNote` .

Now will focus on getting `Depends, Imports, Suggests, Remotes` from these non-CRAN packages and append with data generated by `installed_packages` for CRAN packages.

Next, try `pkgndep` as suggested by Edward Burn:. This seems to be related to Bioconductor (not CRAN) and has its own chain of dependencies. Seems to provide nice visualization for *heaviness* of dependencies.

Notes on `pkgdepR`

Package does not have be in CRAN.

Can specify a list of packages (as in Hades).

Does a thorough analysis of `NAMESPACE`.

`plot(deps)` seems to give a nice visual (can becomes very complex quickly).

Limitations:

-   Analysis at method level (not package level)

-   Static dependencies only

-   Must install package

-   Package must be in search path (i.e. must have an explicit `library(pkg)` statement)

```{r}
# requires BiocVersion which requires BiocManager which requires Bioconductor
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager", repos="https://cloud.r-project.org")
BiocManager::install("BiocVersion")
```

```{r}
# requires BiocVersion which requires BiocManager which requires Bioconductor
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager", repos="https://cloud.r-project.org")
BiocManager::install("BiocVersion")
```

```{r}
# dependency ComplexHeatmap is not available
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager", repos="https://cloud.r-project.org")
```

```{r}
# pkgndep::dependency_report() requires base64
if (!require("base64", quietly = TRUE))
  install.packages("base64", repos="https://cloud.r-project.org")
```

```{r}
library(pkgndep)
pkg <- pkgndep('/Users/rama0/projects/hades')
# plot(pkg, fix_size = FALSE)
# heaviness(pkg)
dependency_report(pkg)
```

Reviewing output (rendered as HTML in browser):

| Package version                                                                                               | 1.4.0 |
|:--------------------------------------------------------------------------------------------------------------|-------|
| Number of strong dependencies                                                                                 | 185   |
| Number of all dependencies                                                                                    | 185   |
| Number of parent packages                                                                                     | 24    |
| Max heaviness from parent packages                                                                            | 28    |
| Total heaviness from parent packages                                                                          | 51    |
| Number of parent packages (including `Suggests` and `Enhances`)                                               | 24    |
| Max co-heaviness from parent packages (**"EnsemblePatientLevelPrediction"** and **"PatientLevelPrediction"**) | 40    |

Parent packages **`PatientLevelPrediction`** and **`EnsemblePatientLevelPrediction`** are the heaviest. Also, their co-heaviness larger than 10. The co-heaviness measures the number of additional dependencies that two parent packages simultaneously import and are only imported by the two parents.

| Parent 1                   | Parent 2                           | Co-heaviness on hades | Co-heaviness as Jaccard coeffcient |
|:---------------------------|:-----------------------------------|----------------------:|-----------------------------------:|
| **PatientLevelPrediction** | **EnsemblePatientLevelPrediction** |                    40 |                              0.976 |

It would be useful to treat these two as outliers and focus on the other 22 packages first.

Additionally, there are about 25 packages that are used only in `EvidenceSynthesis` and another 7 that are exclusive to `ROhdsiWebApi`. Dependencies specific to these two packages may need to be dealt with separately.

Taking one example: `RJSONIO` and `jsonlite` . We know they provide overlapping functionality. We also notice `RJSONIO` is used only by 5 Hades packages, while `jsonlite` is used by 14 Hades packages. Elsewhere we have external validation that `jsonlite` is a more popular package than `RJSONIO` .

We find that CirceR uses `RJSONIO` directly and `jsonlite` indirectly.. We will next drill down on actual usage of `RJSONIO` and its functions in `CirceR`. Let's see if renv::dependencies() will help here.

Taking up specific case of `RJSONIO` . Attempted to follow through and identify specific functions of `JSONIO` using `renv` package. Apparently tracking is done only at package level, not function level.

```{r}
pkg <- pkgndep::pkgndep(package='CirceR', load=T, verbose=T )
pkgndep::dependency_report(pkg)
```

```{r}
if (!require("renv", quietly = TRUE))
  install.packages("renv", repos="https://cloud.r-project.org")
```

Next, looking at usage of `RJSONIO` in packages identified by `pkgndep`.

```{r}
all_deps = list()
for (package in c('CirceR', 'CapR', 'CohortGenerator', 'ROhdsiWebApi', 'CohortDiagnostics')) {
deps <- renv::dependencies(path=paste0('/Users/rama0/projects/', package, '/R'),
                           progress=T,
                           dev=F)
all_deps = rbind(all_deps, deps)
}
selected_deps = all_deps %>%
  as_tibble() %>%
  filter(Package %in% c('RJSONIO')) 
selected_deps
```
