# OHDSI Hades R Packages Dependencies

2022-07-31

Martijin Schuemie, Adam Black, Raj Manickam

Goal

1.  Increase stability of HADES by only depending on reliable third-party packages.
2.  Reduce the HADES install footprint by removing dependencies that can be easily replaced.

Scope

R language dependencies only. Other languages (including Java dependencies) are not in scope for this effort.

Approach

1.  Start with base version of R
2.  Install OHDSI/Hades
3.  Install minimal packages to extract dependencies and create reports

```{r}
sessionInfo()
```

```{r}
hadesPackages <- Hades::listHadesPackages()[,"name"]
hadesPackages
```

```{r}
df <- available.packages() %>%
  as_tibble() %>%
  filter(Package %in% hadesPackages) # %>%
  # select(Package, Depends, Imports, Suggests, Version, LinkingTo, MD5sum) %>%
  # tidyr::pivot_longer(cols = c(-Package), names_to = "type", values_to = "dependency") %>%
  # mutate(dependency = stringr::str_split(dependency, ",")) %>%
  # tidyr::unnest(c(dependency)) %>%
  # mutate(dependency = stringr::str_trim(dependency))

df
```

df has only 7 of 24 Hades Packages

Install all remaining packages

```{r}
remotes::install_github("OHDSI/CohortMethod")

```

Hmmm... CohortMethod *is* installed. Wonder if only packages installed from CRAN show up in installed_packages()

Install all remaining packages using remotes::install_github()

```{r}
# for Hades packages not in df (24 minus 7)
#   remotes::install_github("OHDSI/package")

remotes::install_github("OHDSI/CohortMethod")
remotes::install_github("OHDSI/SelfControlledCaseSeries")
remotes::install_github("OHDSI/SelfControlledCohort")
remotes::install_github("OHDSI/EvidenceSynthesis")
remotes::install_github("OHDSI/PatientLevelPrediction")
remotes::install_github("OHDSI/EnsemblePatientLevelPrediction")
remotes::install_github("OHDSI/Capr")
remotes::install_github("OHDSI/CirceR")
remotes::install_github("OHDSI/CohortGenerator")
remotes::install_github("OHDSI/PhenotypeLibrary")
remotes::install_github("OHDSI/EmpiricalCalibration")
remotes::install_github("OHDSI/MethodEvaluation")
remotes::install_github("OHDSI/CohortDiagnostics")
remotes::install_github("OHDSI/Andromeda")
remotes::install_github("OHDSI/BigKnn")
remotes::install_github("OHDSI/Cyclops")
remotes::install_github("OHDSI/DatabaseConnector")
remotes::install_github("OHDSI/Eunomia")
remotes::install_github("OHDSI/FeatureExtraction")
remotes::install_github("OHDSI/Hydra")
remotes::install_github("OHDSI/OhdsiSharing")
remotes::install_github("OHDSI/ParallelLogger")
remotes::install_github("OHDSI/ROhdsiWebApi")
remotes::install_github("OHDSI/SqlRender")
```

Use `df` produced for CRAN packages as template. For these non-CRAN packages, minimally identify `Depends, Imports, Suggests`. Optionally, `Title, Version, Date, URL, LinkingTo, MD5sum, RoxygenNote` .

Start with understanding role of `DESCRIPTION` and `NAMESPACE`

`NAMESPACE` has two roles:

1.  Identify functions from other packages that are used in our package
2.  Identify functions in our package that are exported (exposed) from use in other packages or R code

We are interested only in #1

`NAMESPACE` is auto-generated by documentation packages like `roxygen2`. As long as developers are inserting documentation tags appropriately, NAMESPACE **will** contain correct entries.

Examining `NAMESPACE` of `CohortMethod`:

Has entries for `S3method, export, import, importFrom, useDynlib.` Will focus on `import, importFrom` .

Not sure what difference is; but looking at corresponding entries in `DESCRIPTION`, `import` seems to correspond to `Depends` and `importFrom` points to entries in `Imports` .

This seems to imply there is overlap / dependencies between `DESCRIPTION` and `NAMESPACE`. Wonder if `DESCRIPTION` alone is good enough for our needs (as it has the sections `Depends, Imports, Suggests` . Interesting, there is an additional section in `DESCRIPTION` that seems to be relevant for us.

Now will focus on getting `Depends, Imports, Suggests, Remotes` from these non-CRAN packages and append with data generated by `installed_packages` for CRAN packages.

Check if `tools::package_dependencies` can be used across both CRAN- and non-CRAN packages.

There are two similar-sounding methods here: `package.dependencies` (now deprecated) and `package_dependencies` .

```{r}
df2 = available.packages()
tools::package_dependencies('Andromeda', db=df2, recursive = T, verbose = T)
```

Appears we can pass in a `db` that has the same structure of output from `installed.packages()` (which works only for CRAN packages).

Note: Tried `pkgndep` as suggested by Edward Burn:. This seems to be related to Bioconductor (not CRAN) and has its own chain of dependencies. Seems to provide nice visualization for *heaviness* of dependencies. Will return to this later if generates continued interest.

``` R
# requires BiocVersion which requires BiocManager which requires Bioconductor
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("BiocVersion")

# dependency ComplexHeatmap is not available
if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

library(pkgndep)
pkg <- pkgndep('/Users/rama0/projects/hades')
plot(pkg, fix_size = FALSE)
heaviness(pkg)
```

Next step: find a way to parse `DESCRIPTION` of non-CRAN packages in Hades and append them to `df`, then run through `tools::package_dependencies()` .
